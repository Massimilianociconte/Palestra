<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Corpo | GYMBRO</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Oswald:wght@500;700&display=swap"
        rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00f3ff">
    
    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GymBro">
    <link rel="apple-touch-icon" href="assets/icon.svg">

    <link rel="icon" type="image/svg+xml" href="assets/icon.svg">
    <link rel="stylesheet" href="css/style.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .measure-card {
            background: var(--color-surface);
            padding: var(--spacing-sm);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .measure-val {
            font-family: var(--font-display);
            font-size: 1.5rem;
            color: var(--color-primary);
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .photo-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            overflow: hidden;
            position: relative;
        }

        .photo-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .photo-info {
            padding: 0.5rem;
            font-size: 0.8rem;
            color: var(--color-text-muted);
            background: rgba(0, 0, 0, 0.8);
            position: absolute;
            bottom: 0;
            width: 100%;
        }

        .chart-container {
            background: var(--color-surface);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            height: 300px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--color-bg);
            padding: 2rem;
            border-radius: var(--radius-md);
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--color-primary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--color-text-muted);
        }

        .form-group input {
            width: 100%;
            padding: 0.8rem;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-main);
            border-radius: 4px;
        }

        /* Health Data Cards */
        .health-card {
            background: linear-gradient(135deg, rgba(0, 243, 255, 0.05) 0%, rgba(0,0,0,0.3) 100%);
            border: 1px solid rgba(0, 243, 255, 0.2);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            animation: fadeInUp 0.5s ease;
        }

        .health-card:hover {
            transform: translateY(-4px);
            border-color: var(--color-primary);
            box-shadow: 0 8px 24px rgba(0, 243, 255, 0.15);
        }

        .health-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--color-primary), transparent);
        }

        .health-card-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .health-card-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-muted);
            margin-bottom: 0.5rem;
        }

        .health-card-value {
            font-family: var(--font-display);
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-primary);
            line-height: 1;
            margin-bottom: 0.25rem;
        }

        .health-card-unit {
            font-size: 0.9rem;
            color: var(--color-text-muted);
            font-weight: 400;
        }

        .health-card-trend {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .health-card-trend.positive {
            color: #10b981;
        }

        .health-card-trend.negative {
            color: #ef4444;
        }

        .health-card.unavailable {
            opacity: 0.5;
            background: rgba(255,255,255,0.02);
            border-color: var(--color-border);
        }

        .health-card.unavailable:hover {
            transform: none;
            box-shadow: none;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinning {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .health-card {
                padding: 1rem;
            }
            
            .health-card-value {
                font-size: 2rem;
            }
        }
    </style>
</head>


        <body>

            <header class="header">
                <div class="container">
                    <a href="index.html" class="logo">GYM<span class="text-primary">BRO</span></a>
                    <nav>
                        <div class="mobile-toggle" id="mobileToggle">‚ò∞</div>
                        <ul class="nav-links" id="navLinks">
                            <li><a href="creator.html">Creator</a></li>
                            <li><a href="diary.html">Diario</a></li>
                            <li><a href="analysis.html">Analisi</a></li>
                            <li><a href="body.html" class="text-primary">Corpo</a></li>
                            <li><a href="user.html">Profilo</a></li>
                        </ul>
                    </nav>
                </div>
            </header>

            <section class="section" style="padding-top: 160px;">
                <div class="container">
                    <h1 style="margin-bottom: var(--spacing-md);">Misure & <span class="text-primary">Progressi</span>
                    </h1>

                    <!-- Google Fit Health Data Section -->
                    <div id="healthDataSection" style="margin-bottom: 3rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h2 style="margin: 0;">Dati <span class="text-primary">Salute</span></h2>
                                <p style="font-size: 0.85rem; color: var(--color-text-muted); margin: 0.25rem 0 0;">
                                    Sincronizzati da Google Fit
                                </p>
                            </div>
                            <div style="display: flex; gap: 0.75rem; align-items: center;">
                                <span id="healthSyncStatus" style="font-size: 0.8rem; color: var(--color-text-muted);"></span>
                                <button id="refreshHealthData" class="btn btn-outline btn-sm">
                                    <span id="refreshIcon">üîÑ</span> Aggiorna
                                </button>
                            </div>
                        </div>

                        <!-- Health Stats Grid -->
                        <div id="healthStatsGrid" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <!-- Dynamic health cards -->
                        </div>

                        <!-- Not Connected Message -->
                        <div id="healthNotConnected" style="display: none; text-align: center; padding: 3rem 1rem; background: rgba(255,255,255,0.02); border: 1px dashed var(--color-border); border-radius: var(--radius-md);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üè•</div>
                            <h3 style="margin-bottom: 0.5rem;">Connetti Google Fit</h3>
                            <p style="color: var(--color-text-muted); margin-bottom: 1.5rem;">
                                Sincronizza i tuoi dati fitness per un monitoraggio completo
                            </p>
                            <a href="user.html" class="btn btn-primary">Vai alle Impostazioni</a>
                        </div>
                    </div>

                    <!-- Chart Section -->
                    <div class="chart-container">
                        <canvas id="progressChart"></canvas>
                    </div>

                    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">

                        <!-- Measurements -->
                        <div>
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3>Misure Corporee</h3>
                                <button id="editStatsBtn" class="btn btn-sm btn-outline">Modifica</button>
                            </div>

                            <div class="grid" style="gap: 1rem;" id="statsDisplay">
                                <!-- Dynamic Stats -->
                            </div>
                        </div>

                        <!-- Photos -->
                        <div>
                            <div class="card" style="margin-bottom: 2rem;">
                                <h3 style="margin-bottom: 1rem;">Parametri Atleta</h3>
                                <p style="font-size: 0.9rem; color: var(--color-text-muted); margin-bottom: 1rem;">
                                    Dati per calcoli futuri (BMR, TDEE, AI).
                                </p>
                                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label>Et√†</label>
                                        <input type="number" id="athleteAge" placeholder="es. 25">
                                    </div>
                                    <div class="form-group">
                                        <label>Altezza (cm)</label>
                                        <input type="number" id="athleteHeight" placeholder="es. 180">
                                    </div>
                                    <div class="form-group">
                                        <label>Sesso</label>
                                        <select id="athleteGender" style="width: 100%; padding: 0.8rem; background: var(--color-bg); border: 1px solid var(--color-border); color: white; border-radius: var(--radius-sm);">
                                            <option value="M">Maschio</option>
                                            <option value="F">Femmina</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Livello Attivit√†</label>
                                        <select id="athleteActivity" style="width: 100%; padding: 0.8rem; background: var(--color-bg); border: 1px solid var(--color-border); color: white; border-radius: var(--radius-sm);">
                                            <option value="sedentary">Sedentario</option>
                                            <option value="light">Leggero (1-3gg)</option>
                                            <option value="moderate">Moderato (3-5gg)</option>
                                            <option value="active">Attivo (6-7gg)</option>
                                            <option value="athlete">Atleta (2x/die)</option>
                                        </select>
                                    </div>
                                </div>
                                <button id="saveParamsBtn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Salva Parametri</button>
                                <p id="paramsStatus" style="margin-top: 0.5rem; font-size: 0.9rem; text-align: center; color: var(--color-primary); min-height: 1.2em;"></p>
                            </div>

                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3>Foto Progressi</h3>
                                <button id="uploadPhotoBtn" class="btn btn-sm btn-primary">+ Nuova Foto</button>
                            </div>

                            <!-- API Key Input (Only visible if not set) -->
                            <div id="apiKeySection" style="margin-bottom: 1rem; display: none;">
                                <input type="text" id="imgbbApiKey" placeholder="Inserisci ImgBB API Key"
                                    style="width: 70%; padding: 0.5rem;">
                                <button id="saveApiKeyBtn" class="btn btn-sm btn-primary">Salva</button>
                                <p style="font-size: 0.7rem; color: var(--color-text-muted); margin-top: 0.5rem;">
                                    Ottieni una chiave gratuita su <a href="https://api.imgbb.com/" target="_blank"
                                        style="color: var(--color-primary);">api.imgbb.com</a>
                                </p>
                            </div>

                            <div class="photo-grid" id="photoGallery">
                                <!-- Dynamic Photos -->
                            </div>
                        </div>

                    </div>
                </div>
            </section>

            <!-- Edit Stats Modal -->
            <div id="statsModal" class="modal">
                <div class="modal-content">
                    <h3 style="margin-bottom: 1.5rem;">Aggiorna Misure</h3>
                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" id="statsDate">
                    </div>
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label id="labelWeight">Peso (kg)</label>
                            <input type="number" id="inputWeight" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Grasso (%)</label>
                            <input type="number" id="inputFat" step="0.1">
                        </div>
                        <div class="form-group">
                            <label id="labelChest">Torace (cm)</label>
                            <input type="number" id="inputChest" step="0.5">
                        </div>
                        <div class="form-group">
                            <label id="labelArm">Braccio (cm)</label>
                            <input type="number" id="inputArm" step="0.5">
                        </div>
                        <div class="form-group">
                            <label id="labelWaist">Vita (cm)</label>
                            <input type="number" id="inputWaist" step="0.5">
                        </div>
                        <div class="form-group">
                            <label id="labelLegs">Gambe (cm)</label>
                            <input type="number" id="inputLegs" step="0.5">
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button id="saveStatsBtn" class="btn btn-primary" style="flex: 1;">Salva</button>
                        <button id="cancelStatsBtn" class="btn btn-outline">Annulla</button>
                    </div>
                </div>
            </div>

            <!-- Upload Photo Modal - CON BF-AI -->
            <div id="photoModal" class="modal">
                <div class="modal-content" style="max-width: 550px;">
                    <h3 style="margin-bottom: 1.5rem;">üì∏ Carica Foto Progresso</h3>
                    <div class="form-group">
                        <label>Seleziona Foto</label>
                        <input type="file" id="photoInput" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label>Nota (opzionale)</label>
                        <input type="text" id="photoNote" placeholder="es. Post workout, 82kg">
                    </div>
                    
                    <!-- BF-AI Option -->
                    <div style="margin: 1.5rem 0; padding: 1rem; background: linear-gradient(135deg, rgba(0,243,255,0.08), rgba(0,0,0,0.2)); border: 1px solid rgba(0,243,255,0.3); border-radius: 8px;">
                        <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer;">
                            <input type="checkbox" id="enableBfaiAnalysis" style="width:20px;height:20px;margin-top:2px;accent-color:#00f3ff;">
                            <span>
                                <strong style="color:#00f3ff;">üéØ Analizza Body Fat con AI</strong><br>
                                <small style="color:#888;">Calcola body fat % con 7 formule scientifiche</small>
                            </span>
                        </label>
                    </div>
                    
                    <!-- BF-AI Params -->
                    <div id="bfaiParamsSection" style="display:none; margin-bottom:1rem;">
                        <h4 style="color:var(--color-primary);margin-bottom:1rem;font-size:0.9rem;">Parametri Analisi</h4>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                            <div class="form-group"><label>Altezza (cm)*</label><input type="number" id="bfaiHeight" min="100" max="250" placeholder="175"></div>
                            <div class="form-group"><label>Peso (kg)*</label><input type="number" id="bfaiWeight" min="30" max="300" step="0.1" placeholder="75"></div>
                            <div class="form-group"><label>Genere*</label><select id="bfaiGender"><option value="male">Uomo</option><option value="female">Donna</option></select></div>
                            <div class="form-group"><label>Et√†</label><input type="number" id="bfaiAge" min="10" max="100" placeholder="30"></div>
                        </div>
                        <div class="form-group"><label>Etnia</label><select id="bfaiEthnicity"><option value="caucasian">Caucasico</option><option value="african_american">Afroamericano</option><option value="asian">Asiatico</option><option value="hispanic">Ispanico</option></select></div>
                    </div>
                    
                    <div id="bfaiResultsContainer"></div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button id="confirmUploadBtn" class="btn btn-primary" style="flex: 1;">Carica</button>
                        <button id="cancelUploadBtn" class="btn btn-outline">Annulla</button>
                    </div>
                    <p id="uploadStatus" style="margin-top: 1rem; text-align: center; color: var(--color-text-muted);"></p>
                </div>
            </div>
                `).join('');
                    }

                    // --- Stats Logic ---
                    editStatsBtn.addEventListener('click', () => {
                        statsModal.style.display = 'flex';
                        document.getElementById('statsDate').valueAsDate = new Date();

                        // Pre-fill with latest (converted to display unit)
                        if (bodyStats.length > 0) {
                            const latest = bodyStats[bodyStats.length - 1];

                            let w = latest.weight, c = latest.chest, a = latest.arm, wa = latest.waist, l = latest.legs;
                            if (unitService) {
                                w = unitService.convertWeight(w);
                                c = unitService.convertLength(c);
                                a = unitService.convertLength(a);
                                wa = unitService.convertLength(wa);
                                l = unitService.convertLength(l);
                            }

                            document.getElementById('inputWeight').value = w || '';
                            document.getElementById('inputFat').value = latest.fat || '';
                            document.getElementById('inputChest').value = c || '';
                            document.getElementById('inputArm').value = a || '';
                            document.getElementById('inputWaist').value = wa || '';
                            document.getElementById('inputLegs').value = l || '';
                        }
                    });

                    saveStatsBtn.addEventListener('click', async () => {
                        const date = document.getElementById('statsDate').value;
                        let weight = parseFloat(document.getElementById('inputWeight').value);
                        const fat = parseFloat(document.getElementById('inputFat').value);
                        let chest = parseFloat(document.getElementById('inputChest').value);
                        let arm = parseFloat(document.getElementById('inputArm').value);
                        let waist = parseFloat(document.getElementById('inputWaist').value);
                        let legs = parseFloat(document.getElementById('inputLegs').value);

                        if (!date) {
                            alert('Inserisci una data.');
                            return;
                        }

                        // Convert back to Metric for storage
                        if (unitService) {
                            if (weight) weight = unitService.toMetricWeight(weight);
                            if (chest) chest = unitService.toMetricLength(chest);
                            if (arm) arm = unitService.toMetricLength(arm);
                            if (waist) waist = unitService.toMetricLength(waist);
                            if (legs) legs = unitService.toMetricLength(legs);
                        }

                        const newStat = {
                            id: Date.now(),
                            date,
                            weight: weight || null,
                            fat: fat || null,
                            chest: chest || null,
                            arm: arm || null,
                            waist: waist || null,
                            legs: legs || null
                        };

                        bodyStats.push(newStat);
                        localStorage.setItem('ironflow_body_stats', JSON.stringify(bodyStats));

                        statsModal.style.display = 'none';
                        renderStats();
                        initChart();

                        if (window.firestoreService) {
                            await window.firestoreService.syncToCloud();
                        }
                    });

                    cancelStatsBtn.addEventListener('click', () => statsModal.style.display = 'none');




                    uploadPhotoBtn.addEventListener('click', () => {
                        photoModal.style.display = 'flex';
                        uploadStatus.textContent = '';
                        document.getElementById('photoInput').value = '';
                        document.getElementById('photoNote').value = '';
                        // Reset BF-AI
                        const chk = document.getElementById('enableBfaiAnalysis');
                        if(chk) { chk.checked = false; document.getElementById('bfaiParamsSection').style.display = 'none'; document.getElementById('bfaiResultsContainer').innerHTML = ''; }
                    });

                    // BF-AI Toggle
                    document.getElementById('enableBfaiAnalysis')?.addEventListener('change', (e) => {
                        document.getElementById('bfaiParamsSection').style.display = e.target.checked ? 'block' : 'none';
                        if (e.target.checked) {
                            const profile = JSON.parse(localStorage.getItem('ironflow_profile') || '{}');
                            const ap = profile.athleteParams || {};
                            if(ap.height) document.getElementById('bfaiHeight').value = ap.height;
                            if(ap.age) document.getElementById('bfaiAge').value = ap.age;
                            if(ap.gender) document.getElementById('bfaiGender').value = ap.gender === 'M' ? 'male' : 'female';
                            const bs = JSON.parse(localStorage.getItem('ironflow_body_stats') || '[]');
                            if(bs.length > 0 && bs[0].weight) document.getElementById('bfaiWeight').value = bs[0].weight;
                        }
                    });

                    cancelUploadBtn.addEventListener('click', () => photoModal.style.display = 'none');

                    confirmUploadBtn.addEventListener('click', async () => {
                        const fileInput = document.getElementById('photoInput');
                        const note = document.getElementById('photoNote').value;
                        const enableBfai = document.getElementById('enableBfaiAnalysis')?.checked;

                        if (fileInput.files.length === 0) {
                            alert('Seleziona una foto.');
                            return;
                        }

                        const file = fileInput.files[0];
                        confirmUploadBtn.disabled = true;
                        let bfaiResult = null;

                        // FASE 1: Analisi BF-AI se abilitata
                        if (enableBfai) {
                            const h = document.getElementById('bfaiHeight').value;
                            const w = document.getElementById('bfaiWeight').value;
                            if (!h || !w) { alert('Inserisci Altezza e Peso per BF-AI'); confirmUploadBtn.disabled = false; return; }
                            
                            uploadStatus.innerHTML = '<span style="color:#00f3ff;">‚è≥ Analisi Body Fat...</span>';
                            try {
                                bfaiResult = await bfAIService.analyzePhoto(file, {
                                    height_cm: parseFloat(h),
                                    weight_kg: parseFloat(w),
                                    gender: document.getElementById('bfaiGender').value,
                                    age: parseInt(document.getElementById('bfaiAge').value) || undefined,
                                    ethnicity: document.getElementById('bfaiEthnicity').value
                                });
                                document.getElementById('bfaiResultsContainer').innerHTML = bfAIService.generateResultsHTML(bfaiResult);
                                uploadStatus.innerHTML = '<span style="color:#00ff88;">‚úì Analisi completata!</span>';
                            } catch (err) {
                                console.error('BF-AI Error:', err);
                                uploadStatus.innerHTML = '<span style="color:#ff6666;">‚ö† ' + err.message + '</span>';
                            }
                        } else {
                            uploadStatus.textContent = 'Caricamento e compressione...';
                        }

                        // FASE 2: Upload foto
                        try {
                            const result = await firestoreService.processPhotoForUpload(file, 600);

                            if (result.success) {
                                const newPhoto = {
                                    id: Date.now(),
                                    url: result.base64,
                                    date: new Date().toISOString(),
                                    note: note
                                };
                                // Aggiungi dati BF-AI se disponibili
                                if (bfaiResult?.success) {
                                    newPhoto.bfai = { bodyFat: bfaiResult.primary, category: bfaiResult.category?.label, composition: bfaiResult.composition };
                                }

                                photos.unshift(newPhoto);
                                if (photos.length > 10) photos = photos.slice(0, 10);
                                localStorage.setItem('ironflow_photos', JSON.stringify(photos));
                                renderPhotos();
                                
                                setTimeout(() => { photoModal.style.display = 'none'; }, bfaiResult ? 2000 : 100);
                                await firestoreService.syncToCloud();
                            } else {
                                throw new Error(result.message);
                            }
                        } catch (error) {
                            console.error('Upload failed:', error);
                            uploadStatus.textContent = 'Errore: ' + error.message;
                        } finally {
                            confirmUploadBtn.disabled = false;
                        }
                    });
                    
                    // --- Init ---
                    renderStats();
                    initChart();
                    renderPhotos();
                });
            </script>
        </body>

</html>
