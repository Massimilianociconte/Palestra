<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corpo | IRONFLOW</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Oswald:wght@500;700&display=swap"
        rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00f3ff">
    <link rel="icon" type="image/svg+xml" href="assets/icon.svg">
    <link rel="stylesheet" href="css/style.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .measure-card {
            background: var(--color-surface);
            padding: var(--spacing-sm);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .measure-val {
            font-family: var(--font-display);
            font-size: 1.5rem;
            color: var(--color-primary);
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .photo-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            overflow: hidden;
            position: relative;
        }

        .photo-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .photo-info {
            padding: 0.5rem;
            font-size: 0.8rem;
            color: var(--color-text-muted);
            background: rgba(0, 0, 0, 0.8);
            position: absolute;
            bottom: 0;
            width: 100%;
        }

        .chart-container {
            background: var(--color-surface);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            height: 300px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--color-bg);
            padding: 2rem;
            border-radius: var(--radius-md);
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--color-primary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--color-text-muted);
        }

        .form-group input {
            width: 100%;
            padding: 0.8rem;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-main);
            border-radius: 4px;
        }
    </style>
</head>


        <body>

            <header class="header">
                <div class="container">
                    <a href="index.html" class="logo">IRON<span class="text-primary">FLOW</span></a>
                    <nav>
                        <div class="mobile-toggle" id="mobileToggle">â˜°</div>
                        <ul class="nav-links" id="navLinks">
                            <li><a href="creator.html">Creator</a></li>
                            <li><a href="diary.html">Diario</a></li>
                            <li><a href="analysis.html">Analisi</a></li>
                            <li><a href="body.html" class="text-primary">Corpo</a></li>
                            <li><a href="user.html">Profilo</a></li>
                        </ul>
                    </nav>
                </div>
            </header>

            <section class="section" style="padding-top: 120px;">
                <div class="container">
                    <h1 style="margin-bottom: var(--spacing-md);">Misure & <span class="text-primary">Progressi</span>
                    </h1>

                    <!-- Chart Section -->
                    <div class="chart-container">
                        <canvas id="progressChart"></canvas>
                    </div>

                    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">

                        <!-- Measurements -->
                        <div>
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3>Misure Corporee</h3>
                                <button id="editStatsBtn" class="btn btn-sm btn-outline">Modifica</button>
                            </div>

                            <div class="grid" style="gap: 1rem;" id="statsDisplay">
                                <!-- Dynamic Stats -->
                            </div>
                        </div>

                        <!-- Photos -->
                        <div>
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3>Foto Progressi</h3>
                                <button id="uploadPhotoBtn" class="btn btn-sm btn-primary">+ Nuova Foto</button>
                            </div>

                            <!-- API Key Input (Only visible if not set) -->
                            <div id="apiKeySection" style="margin-bottom: 1rem; display: none;">
                                <input type="text" id="imgbbApiKey" placeholder="Inserisci ImgBB API Key"
                                    style="width: 70%; padding: 0.5rem;">
                                <button id="saveApiKeyBtn" class="btn btn-sm btn-primary">Salva</button>
                                <p style="font-size: 0.7rem; color: var(--color-text-muted); margin-top: 0.5rem;">
                                    Ottieni una chiave gratuita su <a href="https://api.imgbb.com/" target="_blank"
                                        style="color: var(--color-primary);">api.imgbb.com</a>
                                </p>
                            </div>

                            <div class="photo-grid" id="photoGallery">
                                <!-- Dynamic Photos -->
                            </div>
                        </div>

                    </div>
                </div>
            </section>

            <!-- Edit Stats Modal -->
            <div id="statsModal" class="modal">
                <div class="modal-content">
                    <h3 style="margin-bottom: 1.5rem;">Aggiorna Misure</h3>
                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" id="statsDate">
                    </div>
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label id="labelWeight">Peso (kg)</label>
                            <input type="number" id="inputWeight" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Grasso (%)</label>
                            <input type="number" id="inputFat" step="0.1">
                        </div>
                        <div class="form-group">
                            <label id="labelChest">Torace (cm)</label>
                            <input type="number" id="inputChest" step="0.5">
                        </div>
                        <div class="form-group">
                            <label id="labelArm">Braccio (cm)</label>
                            <input type="number" id="inputArm" step="0.5">
                        </div>
                        <div class="form-group">
                            <label id="labelWaist">Vita (cm)</label>
                            <input type="number" id="inputWaist" step="0.5">
                        </div>
                        <div class="form-group">
                            <label id="labelLegs">Gambe (cm)</label>
                            <input type="number" id="inputLegs" step="0.5">
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button id="saveStatsBtn" class="btn btn-primary" style="flex: 1;">Salva</button>
                        <button id="cancelStatsBtn" class="btn btn-outline">Annulla</button>
                    </div>
                </div>
            </div>

            <!-- Upload Photo Modal -->
            <div id="photoModal" class="modal">
                <div class="modal-content">
                    <h3 style="margin-bottom: 1.5rem;">Carica Foto</h3>
                    <div class="form-group">
                        <label>Seleziona Foto</label>
                        <input type="file" id="photoInput" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label>Nota (opzionale)</label>
                        <input type="text" id="photoNote" placeholder="es. Post workout, 82kg">
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button id="confirmUploadBtn" class="btn btn-primary" style="flex: 1;">Carica</button>
                        <button id="cancelUploadBtn" class="btn btn-outline">Annulla</button>
                    </div>
                    <p id="uploadStatus" style="margin-top: 1rem; text-align: center; color: var(--color-text-muted);">
                    </p>
                </div>
            </div>

            <script src="js/api.js"></script>
            <script src="js/main.js"></script>
            <script type="module">
                import { firestoreService } from './js/firestore-service.js';
                import { authService } from './js/auth-service.js';

                document.addEventListener('DOMContentLoaded', () => {
                    // --- Elements ---
                    const statsDisplay = document.getElementById('statsDisplay');
                    const editStatsBtn = document.getElementById('editStatsBtn');
                    const statsModal = document.getElementById('statsModal');
                    const saveStatsBtn = document.getElementById('saveStatsBtn');
                    const cancelStatsBtn = document.getElementById('cancelStatsBtn');

                    const uploadPhotoBtn = document.getElementById('uploadPhotoBtn');
                    const photoModal = document.getElementById('photoModal');
                    const confirmUploadBtn = document.getElementById('confirmUploadBtn');
                    const cancelUploadBtn = document.getElementById('cancelUploadBtn');
                    const photoGallery = document.getElementById('photoGallery');
                    const uploadStatus = document.getElementById('uploadStatus');

                    // --- State ---
                    let bodyStats = JSON.parse(localStorage.getItem('ironflow_body_stats') || '[]');
                    let photos = JSON.parse(localStorage.getItem('ironflow_photos') || '[]');

                    // Initialize Services (UnitService is global, Firestore is module)
                    let unitService;
                    try {
                        unitService = window.unitService || new UnitService();
                    } catch (e) {
                        console.error('UnitService not available:', e);
                    }
                    
                    // Update Labels based on Unit System
                    const weightUnit = unitService && unitService.getSystem() === 'imperial' ? 'lbs' : 'kg';
                    const lengthUnit = unitService && unitService.getSystem() === 'imperial' ? 'in' : 'cm';

                    document.getElementById('labelWeight').textContent = `Peso (${weightUnit})`;
                    document.getElementById('labelChest').textContent = `Torace (${lengthUnit})`;
                    document.getElementById('labelArm').textContent = `Braccio (${lengthUnit})`;
                    document.getElementById('labelWaist').textContent = `Vita (${lengthUnit})`;
                    document.getElementById('labelLegs').textContent = `Gambe (${lengthUnit})`;

                    // Load Data from Cloud on Init
                    async function loadData() {
                         const result = await firestoreService.loadFromCloud();
                         if (result.success && result.data) {
                             if (result.data.bodyStats) bodyStats = result.data.bodyStats;
                             if (result.data.photos) photos = result.data.photos;
                             renderStats();
                             initChart();
                             renderPhotos();
                         }
                    }
                    
                    // Auth Listener to trigger load
                    authService.subscribe(user => {
                        if(user) loadData();
                    });


                    // ... (Chart and Stats logic remains the same) ...
                    // --- Chart.js Setup ---
                    const ctx = document.getElementById('progressChart').getContext('2d');
                    let chart;

                    function initChart() {
                        // Sort stats by date
                        bodyStats.sort((a, b) => new Date(a.date) - new Date(b.date));

                        const labels = bodyStats.map(s => new Date(s.date).toLocaleDateString('it-IT', { day: 'numeric', month: 'short' }));

                        // Convert data for chart
                        const weightData = bodyStats.map(s => unitService ? unitService.convertWeight(s.weight) : s.weight);
                        const fatData = bodyStats.map(s => s.fat);

                        if (chart) chart.destroy();

                        chart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: `Peso (${weightUnit})`,
                                        data: weightData,
                                        borderColor: '#e0ff00',
                                        backgroundColor: 'rgba(224, 255, 0, 0.1)',
                                        tension: 0.4,
                                        yAxisID: 'y'
                                    },
                                    {
                                        label: 'Grasso (%)',
                                        data: fatData,
                                        borderColor: '#ffffff',
                                        borderDash: [5, 5],
                                        tension: 0.4,
                                        yAxisID: 'y1'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    mode: 'index',
                                    intersect: false,
                                },
                                plugins: {
                                    legend: { labels: { color: '#aaa' } },
                                    tooltip: {
                                        callbacks: {
                                            afterBody: function (context) {
                                                const index = context[0].dataIndex;
                                                const stat = bodyStats[index];

                                                let chest = stat.chest, arm = stat.arm, waist = stat.waist, legs = stat.legs;

                                                if (unitService) {
                                                    chest = unitService.convertLength(chest);
                                                    arm = unitService.convertLength(arm);
                                                    waist = unitService.convertLength(waist);
                                                    legs = unitService.convertLength(legs);
                                                }

                                                return `Torace: ${chest || '-'} ${lengthUnit}\nBraccio: ${arm || '-'} ${lengthUnit}\nVita: ${waist || '-'} ${lengthUnit}\nGambe: ${legs || '-'} ${lengthUnit}`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: { ticks: { color: '#aaa' }, grid: { color: '#333' } },
                                    y: {
                                        type: 'linear',
                                        display: true,
                                        position: 'left',
                                        ticks: { color: '#aaa' },
                                        grid: { color: '#333' }
                                    },
                                    y1: {
                                        type: 'linear',
                                        display: true,
                                        position: 'right',
                                        grid: { drawOnChartArea: false },
                                        ticks: { color: '#aaa' }
                                    }
                                }
                            }
                        });
                    }

                    // --- Render Stats ---
                    function renderStats() {
                        const latest = bodyStats.length > 0 ? bodyStats[bodyStats.length - 1] : {};

                        let w = latest.weight, c = latest.chest, a = latest.arm, wa = latest.waist, l = latest.legs;

                        if (unitService) {
                            w = unitService.convertWeight(w);
                            c = unitService.convertLength(c);
                            a = unitService.convertLength(a);
                            wa = unitService.convertLength(wa);
                            l = unitService.convertLength(l);
                        }

                        const items = [
                            { label: 'Peso Corporeo', val: w, unit: weightUnit },
                            { label: '% Grasso', val: latest.fat, unit: '%' },
                            { label: 'Torace', val: c, unit: lengthUnit },
                            { label: 'Braccio', val: a, unit: lengthUnit },
                            { label: 'Vita', val: wa, unit: lengthUnit },
                            { label: 'Gambe', val: l, unit: lengthUnit }
                        ];

                        statsDisplay.innerHTML = items.map(item => `
                    <div class="measure-card">
                        <span>${item.label}</span>
                        <span class="measure-val">${item.val || '-'} <span style="font-size: 0.8rem; color: var(--color-text-muted);">${item.unit}</span></span>
                    </div>
                `).join('');
                    }

                    // --- Render Photos ---
                    function renderPhotos() {
                        photoGallery.innerHTML = photos.map(p => `
                    <div class="photo-card">
                        <a href="${p.url}" target="_blank">
                            <img src="${p.thumb || p.url}" alt="Progress Photo">
                        </a>
                        <div class="photo-info">
                            <div>${new Date(p.date).toLocaleDateString()}</div>
                            <div>${p.note || ''}</div>
                        </div>
                    </div>
                `).join('');
                    }

                    // --- Stats Logic ---
                    editStatsBtn.addEventListener('click', () => {
                        statsModal.style.display = 'flex';
                        document.getElementById('statsDate').valueAsDate = new Date();

                        // Pre-fill with latest (converted to display unit)
                        if (bodyStats.length > 0) {
                            const latest = bodyStats[bodyStats.length - 1];

                            let w = latest.weight, c = latest.chest, a = latest.arm, wa = latest.waist, l = latest.legs;
                            if (unitService) {
                                w = unitService.convertWeight(w);
                                c = unitService.convertLength(c);
                                a = unitService.convertLength(a);
                                wa = unitService.convertLength(wa);
                                l = unitService.convertLength(l);
                            }

                            document.getElementById('inputWeight').value = w || '';
                            document.getElementById('inputFat').value = latest.fat || '';
                            document.getElementById('inputChest').value = c || '';
                            document.getElementById('inputArm').value = a || '';
                            document.getElementById('inputWaist').value = wa || '';
                            document.getElementById('inputLegs').value = l || '';
                        }
                    });

                    saveStatsBtn.addEventListener('click', async () => {
                        const date = document.getElementById('statsDate').value;
                        let weight = parseFloat(document.getElementById('inputWeight').value);
                        const fat = parseFloat(document.getElementById('inputFat').value);
                        let chest = parseFloat(document.getElementById('inputChest').value);
                        let arm = parseFloat(document.getElementById('inputArm').value);
                        let waist = parseFloat(document.getElementById('inputWaist').value);
                        let legs = parseFloat(document.getElementById('inputLegs').value);

                        if (!date) {
                            alert('Inserisci una data.');
                            return;
                        }

                        // Convert back to Metric for storage
                        if (unitService) {
                            if (weight) weight = unitService.toMetricWeight(weight);
                            if (chest) chest = unitService.toMetricLength(chest);
                            if (arm) arm = unitService.toMetricLength(arm);
                            if (waist) waist = unitService.toMetricLength(waist);
                            if (legs) legs = unitService.toMetricLength(legs);
                        }

                        const newStat = {
                            id: Date.now(),
                            date,
                            weight: weight || null,
                            fat: fat || null,
                            chest: chest || null,
                            arm: arm || null,
                            waist: waist || null,
                            legs: legs || null
                        };

                        bodyStats.push(newStat);
                        localStorage.setItem('ironflow_body_stats', JSON.stringify(bodyStats));

                        statsModal.style.display = 'none';
                        renderStats();
                        initChart();

                        if (window.firestoreService) {
                            await window.firestoreService.syncToCloud();
                        }
                    });

                    cancelStatsBtn.addEventListener('click', () => statsModal.style.display = 'none');




                    uploadPhotoBtn.addEventListener('click', () => {
                        photoModal.style.display = 'flex';
                        uploadStatus.textContent = '';
                        document.getElementById('photoInput').value = '';
                        document.getElementById('photoNote').value = '';
                    });

                    cancelUploadBtn.addEventListener('click', () => photoModal.style.display = 'none');

                    confirmUploadBtn.addEventListener('click', async () => {
                        const fileInput = document.getElementById('photoInput');
                        const note = document.getElementById('photoNote').value;

                        if (fileInput.files.length === 0) {
                            alert('Seleziona una foto.');
                            return;
                        }

                        const file = fileInput.files[0];
                        uploadStatus.textContent = 'Caricamento e compressione...';
                        confirmUploadBtn.disabled = true;

                        try {
                            // Use Firestore Service to process (resize) image to Base64
                            const result = await firestoreService.processPhotoForUpload(file, 600); // Max width 600px

                            if (result.success) {
                                const newPhoto = {
                                    id: Date.now(),
                                    url: result.base64, // Store Base64 directly
                                    date: new Date().toISOString(),
                                    note: note
                                };

                                photos.unshift(newPhoto);
                                // Limit photos to avoid hitting document size limits (e.g. keep last 10 locally/doc)
                                // For a real app, we'd use a subcollection, but for this single-doc architecture:
                                if (photos.length > 10) photos = photos.slice(0, 10);

                                localStorage.setItem('ironflow_photos', JSON.stringify(photos));

                                renderPhotos();
                                photoModal.style.display = 'none';

                                // Sync to Firestore
                                await firestoreService.syncToCloud();
                            } else {
                                throw new Error(result.message);
                            }
                        } catch (error) {
                            console.error('Upload failed:', error);
                            uploadStatus.textContent = 'Errore: ' + error.message;
                        } finally {
                            confirmUploadBtn.disabled = false;
                        }
                    });
                    
                    // --- Init ---
                    renderStats();
                    initChart();
                    renderPhotos();
                });
            </script>
        </body>

</html>