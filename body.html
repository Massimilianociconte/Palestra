<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corpo | IRONFLOW</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Oswald:wght@500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .measure-card {
            background: var(--color-surface);
            padding: var(--spacing-sm);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .measure-val {
            font-family: var(--font-display);
            font-size: 1.5rem;
            color: var(--color-primary);
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .photo-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            overflow: hidden;
            position: relative;
        }

        .photo-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .photo-info {
            padding: 0.5rem;
            font-size: 0.8rem;
            color: var(--color-text-muted);
            background: rgba(0, 0, 0, 0.8);
            position: absolute;
            bottom: 0;
            width: 100%;
        }

        .chart-container {
            background: var(--color-surface);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            height: 300px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--color-bg);
            padding: 2rem;
            border-radius: var(--radius-md);
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--color-primary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--color-text-muted);
        }

        .form-group input {
            width: 100%;
            padding: 0.8rem;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-main);
            border-radius: 4px;
        }
    </style>
</head>

<body>

    <header class="header">
        <div class="container">
            <a href="index.html" class="logo">IRON<span class="text-primary">FLOW</span></a>
            <nav>
                <div class="mobile-toggle" id="mobileToggle">â˜°</div>
                <ul class="nav-links" id="navLinks">
                    <li><a href="creator.html">Creator</a></li>
                    <li><a href="diary.html">Diario</a></li>
                    <li><a href="analysis.html">Analisi</a></li>
                    <li><a href="body.html" class="text-primary">Corpo</a></li>
                    <li><a href="user.html">Profilo</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="section" style="padding-top: 120px;">
        <div class="container">
            <h1 style="margin-bottom: var(--spacing-md);">Misure & <span class="text-primary">Progressi</span></h1>

            <!-- Chart Section -->
            <div class="chart-container">
                <canvas id="progressChart"></canvas>
            </div>

            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">

                <!-- Measurements -->
                <div>
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Misure Corporee</h3>
                        <button id="editStatsBtn" class="btn btn-sm btn-outline">Modifica</button>
                    </div>

                    <div class="grid" style="gap: 1rem;" id="statsDisplay">
                        <!-- Dynamic Stats -->
                    </div>
                </div>

                <!-- Photos -->
                <div>
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Foto Progressi</h3>
                        <button id="uploadPhotoBtn" class="btn btn-sm btn-primary">+ Nuova Foto</button>
                    </div>

                    <!-- API Key Input (Only visible if not set) -->
                    <div id="apiKeySection" style="margin-bottom: 1rem; display: none;">
                        <input type="text" id="imgbbApiKey" placeholder="Inserisci ImgBB API Key"
                            style="width: 70%; padding: 0.5rem;">
                        <button id="saveApiKeyBtn" class="btn btn-sm btn-primary">Salva</button>
                        <p style="font-size: 0.7rem; color: var(--color-text-muted); margin-top: 0.5rem;">
                            Ottieni una chiave gratuita su <a href="https://api.imgbb.com/" target="_blank"
                                style="color: var(--color-primary);">api.imgbb.com</a>
                        </p>
                    </div>

                    <div class="photo-grid" id="photoGallery">
                        <!-- Dynamic Photos -->
                    </div>
                </div>

            </div>
        </div>
    </section>

    <!-- Edit Stats Modal -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 1.5rem;">Aggiorna Misure</h3>
            <div class="form-group">
                <label>Data</label>
                <input type="date" id="statsDate">
            </div>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Peso (kg)</label>
                    <input type="number" id="inputWeight" step="0.1">
                </div>
                <div class="form-group">
                    <label>Grasso (%)</label>
                    <input type="number" id="inputFat" step="0.1">
                </div>
                <div class="form-group">
                    <label>Torace (cm)</label>
                    <input type="number" id="inputChest" step="0.5">
                </div>
                <div class="form-group">
                    <label>Braccio (cm)</label>
                    <input type="number" id="inputArm" step="0.5">
                </div>
                <div class="form-group">
                    <label>Vita (cm)</label>
                    <input type="number" id="inputWaist" step="0.5">
                </div>
                <div class="form-group">
                    <label>Gambe (cm)</label>
                    <input type="number" id="inputLegs" step="0.5">
                </div>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button id="saveStatsBtn" class="btn btn-primary" style="flex: 1;">Salva</button>
                <button id="cancelStatsBtn" class="btn btn-outline">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Upload Photo Modal -->
    <div id="photoModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 1.5rem;">Carica Foto</h3>
            <div class="form-group">
                <label>Seleziona Foto</label>
                <input type="file" id="photoInput" accept="image/*">
            </div>
            <div class="form-group">
                <label>Nota (opzionale)</label>
                <input type="text" id="photoNote" placeholder="es. Post workout, 82kg">
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button id="confirmUploadBtn" class="btn btn-primary" style="flex: 1;">Carica</button>
                <button id="cancelUploadBtn" class="btn btn-outline">Annulla</button>
            </div>
            <p id="uploadStatus" style="margin-top: 1rem; text-align: center; color: var(--color-text-muted);"></p>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elements ---
            const statsDisplay = document.getElementById('statsDisplay');
            const editStatsBtn = document.getElementById('editStatsBtn');
            const statsModal = document.getElementById('statsModal');
            const saveStatsBtn = document.getElementById('saveStatsBtn');
            const cancelStatsBtn = document.getElementById('cancelStatsBtn');

            const uploadPhotoBtn = document.getElementById('uploadPhotoBtn');
            const photoModal = document.getElementById('photoModal');
            const confirmUploadBtn = document.getElementById('confirmUploadBtn');
            const cancelUploadBtn = document.getElementById('cancelUploadBtn');
            const photoGallery = document.getElementById('photoGallery');
            const apiKeySection = document.getElementById('apiKeySection');
            const imgbbApiKeyInput = document.getElementById('imgbbApiKey');
            const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
            const uploadStatus = document.getElementById('uploadStatus');

            // --- State ---
            let bodyStats = JSON.parse(localStorage.getItem('ironflow_body_stats') || '[]');
            let photos = JSON.parse(localStorage.getItem('ironflow_photos') || '[]');
            let imgbbKey = localStorage.getItem('ironflow_imgbb_key');

            // Initialize API Service safely
            let storageService;
            try {
                storageService = window.storageService || new StorageService();
            } catch (e) {
                console.error('StorageService not available:', e);
            }

            // --- Chart.js Setup ---
            const ctx = document.getElementById('progressChart').getContext('2d');
            let chart;

            function initChart() {
                // Sort stats by date
                bodyStats.sort((a, b) => new Date(a.date) - new Date(b.date));

                const labels = bodyStats.map(s => new Date(s.date).toLocaleDateString('it-IT', { day: 'numeric', month: 'short' }));
                const weightData = bodyStats.map(s => s.weight);
                const fatData = bodyStats.map(s => s.fat);

                if (chart) chart.destroy();

                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Peso (kg)',
                                data: weightData,
                                borderColor: '#e0ff00',
                                backgroundColor: 'rgba(224, 255, 0, 0.1)',
                                tension: 0.4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Grasso (%)',
                                data: fatData,
                                borderColor: '#ffffff',
                                borderDash: [5, 5],
                                tension: 0.4,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: { labels: { color: '#aaa' } },
                            tooltip: {
                                callbacks: {
                                    afterBody: function (context) {
                                        const index = context[0].dataIndex;
                                        const stat = bodyStats[index];
                                        return `Torace: ${stat.chest || '-'} cm\nBraccio: ${stat.arm || '-'} cm\nVita: ${stat.waist || '-'} cm\nGambe: ${stat.legs || '-'} cm`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { ticks: { color: '#aaa' }, grid: { color: '#333' } },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                ticks: { color: '#aaa' },
                                grid: { color: '#333' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: { drawOnChartArea: false },
                                ticks: { color: '#aaa' }
                            }
                        }
                    }
                });
            }

            // --- Render Stats ---
            function renderStats() {
                const latest = bodyStats.length > 0 ? bodyStats[bodyStats.length - 1] : {};

                const items = [
                    { label: 'Peso Corporeo', val: latest.weight, unit: 'kg' },
                    { label: '% Grasso', val: latest.fat, unit: '%' },
                    { label: 'Torace', val: latest.chest, unit: 'cm' },
                    { label: 'Braccio', val: latest.arm, unit: 'cm' },
                    { label: 'Vita', val: latest.waist, unit: 'cm' },
                    { label: 'Gambe', val: latest.legs, unit: 'cm' }
                ];

                statsDisplay.innerHTML = items.map(item => `
                    <div class="measure-card">
                        <span>${item.label}</span>
                        <span class="measure-val">${item.val || '-'} <span style="font-size: 0.8rem; color: var(--color-text-muted);">${item.unit}</span></span>
                    </div>
                `).join('');
            }

            // --- Render Photos ---
            function renderPhotos() {
                photoGallery.innerHTML = photos.map(p => `
                    <div class="photo-card">
                        <a href="${p.url}" target="_blank">
                            <img src="${p.thumb || p.url}" alt="Progress Photo">
                        </a>
                        <div class="photo-info">
                            <div>${new Date(p.date).toLocaleDateString()}</div>
                            <div>${p.note || ''}</div>
                        </div>
                    </div>
                `).join('');
            }

            // --- Stats Logic ---
            editStatsBtn.addEventListener('click', () => {
                statsModal.style.display = 'flex';
                document.getElementById('statsDate').valueAsDate = new Date();

                // Pre-fill with latest
                if (bodyStats.length > 0) {
                    const latest = bodyStats[bodyStats.length - 1];
                    document.getElementById('inputWeight').value = latest.weight || '';
                    document.getElementById('inputFat').value = latest.fat || '';
                    document.getElementById('inputChest').value = latest.chest || '';
                    document.getElementById('inputArm').value = latest.arm || '';
                    document.getElementById('inputWaist').value = latest.waist || '';
                    document.getElementById('inputLegs').value = latest.legs || '';
                }

                saveApiKeyBtn.addEventListener('click', () => {
                    const key = imgbbApiKeyInput.value.trim();
                    if (key) {
                        localStorage.setItem('ironflow_imgbb_key', key);
                        imgbbKey = key;
                        apiKeySection.style.display = 'none';
                        uploadPhotoBtn.style.display = 'block';
                    }
                });

                uploadPhotoBtn.addEventListener('click', () => {
                    photoModal.style.display = 'flex';
                    uploadStatus.textContent = '';
                    document.getElementById('photoInput').value = '';
                    document.getElementById('photoNote').value = '';
                });

                cancelUploadBtn.addEventListener('click', () => photoModal.style.display = 'none');

                confirmUploadBtn.addEventListener('click', async () => {
                    const fileInput = document.getElementById('photoInput');
                    const note = document.getElementById('photoNote').value;

                    if (fileInput.files.length === 0) {
                        alert('Seleziona una foto.');
                        return;
                    }

                    const file = fileInput.files[0];
                    const formData = new FormData();
                    formData.append('image', file);

                    uploadStatus.textContent = 'Caricamento in corso...';
                    confirmUploadBtn.disabled = true;

                    try {
                        const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbKey}`, {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            const newPhoto = {
                                id: Date.now(),
                                url: result.data.url,
                                thumb: result.data.thumb.url,
                                delete_url: result.data.delete_url,
                                date: new Date().toISOString(),
                                note: note
                            };

                            photos.unshift(newPhoto);
                            localStorage.setItem('ironflow_photos', JSON.stringify(photos));

                            renderPhotos();
                            photoModal.style.display = 'none';

                            // Sync
                            if (storageService && storageService.hasCredentials()) {
                                await storageService.syncData();
                            }
                        } else {
                            throw new Error(result.error.message);
                        }
                    } catch (error) {
                        console.error('Upload failed:', error);
                        uploadStatus.textContent = 'Errore: ' + error.message;
                    } finally {
                        confirmUploadBtn.disabled = false;
                    }
                });

                // --- Init ---
                renderStats();
                initChart();
                renderPhotos();
            });
    </script>
</body>

</html>